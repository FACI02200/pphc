/*
 * PPH Constants - Tax tables and rates
 * Copyright (c) 2025 OpenPajak Contributors
 */

#include <pph/pph_calculator.h>

/* ============================================
   PTKP Table (Penghasilan Tidak Kena Pajak)
   ============================================ */

static const pph_money_t PPH_PTKP_TABLE[8] = {
    PPH_RUPIAH_STATIC(54000000),  /* TK/0: 54,000,000 */
    PPH_RUPIAH_STATIC(58500000),  /* TK/1: 58,500,000 */
    PPH_RUPIAH_STATIC(63000000),  /* TK/2: 63,000,000 */
    PPH_RUPIAH_STATIC(67500000),  /* TK/3: 67,500,000 */
    PPH_RUPIAH_STATIC(58500000),  /* K/0: 58,500,000 */
    PPH_RUPIAH_STATIC(63000000),  /* K/1: 63,000,000 */
    PPH_RUPIAH_STATIC(67500000),  /* K/2: 67,500,000 */
    PPH_RUPIAH_STATIC(72000000)   /* K/3: 72,000,000 */
};

pph_money_t pph_get_ptkp(pph_ptkp_status_t status) {
    if (status < 0 || status > 7) {
        return PPH_PTKP_TABLE[0];  /* Default to TK/0 */
    }
    return PPH_PTKP_TABLE[status];
}

/* ============================================
   Pasal 17 Progressive Tax Layers
   ============================================ */

typedef struct {
    pph_money_t limit;
    pph_money_t rate;  /* Stored as fraction (0.05 = 500/10000) */
} pasal17_layer_t;

#define PASAL17_LAYER_COUNT 5

static const pasal17_layer_t PPH_PASAL17_LAYERS[PASAL17_LAYER_COUNT] = {
    { PPH_RUPIAH_STATIC(60000000),    PPH_MONEY_STATIC(0, 500) },   /* 5% = 0.0500 */
    { PPH_RUPIAH_STATIC(190000000),   PPH_MONEY_STATIC(0, 1500) },  /* 15% = 0.1500 */
    { PPH_RUPIAH_STATIC(250000000),   PPH_MONEY_STATIC(0, 2500) },  /* 25% = 0.2500 */
    { PPH_RUPIAH_STATIC(4500000000),  PPH_MONEY_STATIC(0, 3000) },  /* 30% = 0.3000 */
    { PPH_RUPIAH_STATIC(2147483647),  PPH_MONEY_STATIC(0, 3500) }   /* 35% = 0.3500, use max int as infinity */
};

pph_money_t pph_calculate_pasal17(pph_money_t pkp) {
    pph_money_t tax = PPH_ZERO;
    pph_money_t remaining = pkp;
    int i;

    for (i = 0; i < PASAL17_LAYER_COUNT; i++) {
        pph_money_t taxable, layer_tax;

        if (remaining.value <= 0) {
            break;
        }

        taxable = pph_money_min(remaining, PPH_PASAL17_LAYERS[i].limit);
        layer_tax = pph_money_mul(taxable, PPH_PASAL17_LAYERS[i].rate);

        tax = pph_money_add(tax, layer_tax);
        remaining = pph_money_sub(remaining, taxable);
    }

    return tax;
}

/* ============================================
   TER Bulanan (Monthly) Tables
   ============================================ */

typedef struct {
    pph_money_t ceiling;
    pph_money_t rate;
} ter_entry_t;

#define TER_BULANAN_A_COUNT 44
#define TER_BULANAN_B_COUNT 40
#define TER_BULANAN_C_COUNT 41

static const ter_entry_t TER_BULANAN_A[TER_BULANAN_A_COUNT] = {
    { PPH_RUPIAH_STATIC(5400000), PPH_MONEY_STATIC(0, 0) },
    { PPH_RUPIAH_STATIC(5650000), PPH_MONEY_STATIC(0, 25) },
    { PPH_RUPIAH_STATIC(5950000), PPH_MONEY_STATIC(0, 50) },
    { PPH_RUPIAH_STATIC(6300000), PPH_MONEY_STATIC(0, 75) },
    { PPH_RUPIAH_STATIC(6750000), PPH_MONEY_STATIC(0, 100) },
    { PPH_RUPIAH_STATIC(7500000), PPH_MONEY_STATIC(0, 125) },
    { PPH_RUPIAH_STATIC(8550000), PPH_MONEY_STATIC(0, 150) },
    { PPH_RUPIAH_STATIC(9650000), PPH_MONEY_STATIC(0, 175) },
    { PPH_RUPIAH_STATIC(10050000), PPH_MONEY_STATIC(0, 200) },
    { PPH_RUPIAH_STATIC(10350000), PPH_MONEY_STATIC(0, 225) },
    { PPH_RUPIAH_STATIC(10700000), PPH_MONEY_STATIC(0, 250) },
    { PPH_RUPIAH_STATIC(11050000), PPH_MONEY_STATIC(0, 300) },
    { PPH_RUPIAH_STATIC(11600000), PPH_MONEY_STATIC(0, 350) },
    { PPH_RUPIAH_STATIC(12500000), PPH_MONEY_STATIC(0, 400) },
    { PPH_RUPIAH_STATIC(13750000), PPH_MONEY_STATIC(0, 500) },
    { PPH_RUPIAH_STATIC(15100000), PPH_MONEY_STATIC(0, 600) },
    { PPH_RUPIAH_STATIC(16950000), PPH_MONEY_STATIC(0, 700) },
    { PPH_RUPIAH_STATIC(19750000), PPH_MONEY_STATIC(0, 800) },
    { PPH_RUPIAH_STATIC(24150000), PPH_MONEY_STATIC(0, 900) },
    { PPH_RUPIAH_STATIC(26450000), PPH_MONEY_STATIC(0, 1000) },
    { PPH_RUPIAH_STATIC(28000000), PPH_MONEY_STATIC(0, 1100) },
    { PPH_RUPIAH_STATIC(30050000), PPH_MONEY_STATIC(0, 1200) },
    { PPH_RUPIAH_STATIC(32400000), PPH_MONEY_STATIC(0, 1300) },
    { PPH_RUPIAH_STATIC(35400000), PPH_MONEY_STATIC(0, 1400) },
    { PPH_RUPIAH_STATIC(39100000), PPH_MONEY_STATIC(0, 1500) },
    { PPH_RUPIAH_STATIC(43850000), PPH_MONEY_STATIC(0, 1600) },
    { PPH_RUPIAH_STATIC(47800000), PPH_MONEY_STATIC(0, 1700) },
    { PPH_RUPIAH_STATIC(51400000), PPH_MONEY_STATIC(0, 1800) },
    { PPH_RUPIAH_STATIC(56300000), PPH_MONEY_STATIC(0, 1900) },
    { PPH_RUPIAH_STATIC(62200000), PPH_MONEY_STATIC(0, 2000) },
    { PPH_RUPIAH_STATIC(68600000), PPH_MONEY_STATIC(0, 2100) },
    { PPH_RUPIAH_STATIC(77500000), PPH_MONEY_STATIC(0, 2200) },
    { PPH_RUPIAH_STATIC(89000000), PPH_MONEY_STATIC(0, 2300) },
    { PPH_RUPIAH_STATIC(103000000), PPH_MONEY_STATIC(0, 2400) },
    { PPH_RUPIAH_STATIC(125000000), PPH_MONEY_STATIC(0, 2500) },
    { PPH_RUPIAH_STATIC(157000000), PPH_MONEY_STATIC(0, 2600) },
    { PPH_RUPIAH_STATIC(206000000), PPH_MONEY_STATIC(0, 2700) },
    { PPH_RUPIAH_STATIC(337000000), PPH_MONEY_STATIC(0, 2800) },
    { PPH_RUPIAH_STATIC(454000000), PPH_MONEY_STATIC(0, 2900) },
    { PPH_RUPIAH_STATIC(550000000), PPH_MONEY_STATIC(0, 3000) },
    { PPH_RUPIAH_STATIC(695000000), PPH_MONEY_STATIC(0, 3100) },
    { PPH_RUPIAH_STATIC(910000000), PPH_MONEY_STATIC(0, 3200) },
    { PPH_RUPIAH_STATIC(1400000000), PPH_MONEY_STATIC(0, 3300) },
    { PPH_RUPIAH_STATIC(2147483647), PPH_MONEY_STATIC(0, 3400) }  /* Infinity */
};

static const ter_entry_t TER_BULANAN_B[TER_BULANAN_B_COUNT] = {
    { PPH_RUPIAH_STATIC(6200000), PPH_MONEY_STATIC(0, 0) },
    { PPH_RUPIAH_STATIC(6500000), PPH_MONEY_STATIC(0, 25) },
    { PPH_RUPIAH_STATIC(6850000), PPH_MONEY_STATIC(0, 50) },
    { PPH_RUPIAH_STATIC(7300000), PPH_MONEY_STATIC(0, 75) },
    { PPH_RUPIAH_STATIC(9200000), PPH_MONEY_STATIC(0, 100) },
    { PPH_RUPIAH_STATIC(10750000), PPH_MONEY_STATIC(0, 150) },
    { PPH_RUPIAH_STATIC(11250000), PPH_MONEY_STATIC(0, 200) },
    { PPH_RUPIAH_STATIC(11600000), PPH_MONEY_STATIC(0, 250) },
    { PPH_RUPIAH_STATIC(12600000), PPH_MONEY_STATIC(0, 300) },
    { PPH_RUPIAH_STATIC(13600000), PPH_MONEY_STATIC(0, 400) },
    { PPH_RUPIAH_STATIC(14950000), PPH_MONEY_STATIC(0, 500) },
    { PPH_RUPIAH_STATIC(16400000), PPH_MONEY_STATIC(0, 600) },
    { PPH_RUPIAH_STATIC(18450000), PPH_MONEY_STATIC(0, 700) },
    { PPH_RUPIAH_STATIC(21850000), PPH_MONEY_STATIC(0, 800) },
    { PPH_RUPIAH_STATIC(26000000), PPH_MONEY_STATIC(0, 900) },
    { PPH_RUPIAH_STATIC(27700000), PPH_MONEY_STATIC(0, 1000) },
    { PPH_RUPIAH_STATIC(29350000), PPH_MONEY_STATIC(0, 1100) },
    { PPH_RUPIAH_STATIC(31450000), PPH_MONEY_STATIC(0, 1200) },
    { PPH_RUPIAH_STATIC(33950000), PPH_MONEY_STATIC(0, 1300) },
    { PPH_RUPIAH_STATIC(37100000), PPH_MONEY_STATIC(0, 1400) },
    { PPH_RUPIAH_STATIC(41100000), PPH_MONEY_STATIC(0, 1500) },
    { PPH_RUPIAH_STATIC(45800000), PPH_MONEY_STATIC(0, 1600) },
    { PPH_RUPIAH_STATIC(49500000), PPH_MONEY_STATIC(0, 1700) },
    { PPH_RUPIAH_STATIC(53800000), PPH_MONEY_STATIC(0, 1800) },
    { PPH_RUPIAH_STATIC(58500000), PPH_MONEY_STATIC(0, 1900) },
    { PPH_RUPIAH_STATIC(64000000), PPH_MONEY_STATIC(0, 2000) },
    { PPH_RUPIAH_STATIC(71000000), PPH_MONEY_STATIC(0, 2100) },
    { PPH_RUPIAH_STATIC(80000000), PPH_MONEY_STATIC(0, 2200) },
    { PPH_RUPIAH_STATIC(93000000), PPH_MONEY_STATIC(0, 2300) },
    { PPH_RUPIAH_STATIC(109000000), PPH_MONEY_STATIC(0, 2400) },
    { PPH_RUPIAH_STATIC(129000000), PPH_MONEY_STATIC(0, 2500) },
    { PPH_RUPIAH_STATIC(163000000), PPH_MONEY_STATIC(0, 2600) },
    { PPH_RUPIAH_STATIC(211000000), PPH_MONEY_STATIC(0, 2700) },
    { PPH_RUPIAH_STATIC(374000000), PPH_MONEY_STATIC(0, 2800) },
    { PPH_RUPIAH_STATIC(459000000), PPH_MONEY_STATIC(0, 2900) },
    { PPH_RUPIAH_STATIC(555000000), PPH_MONEY_STATIC(0, 3000) },
    { PPH_RUPIAH_STATIC(704000000), PPH_MONEY_STATIC(0, 3100) },
    { PPH_RUPIAH_STATIC(957000000), PPH_MONEY_STATIC(0, 3200) },
    { PPH_RUPIAH_STATIC(1405000000), PPH_MONEY_STATIC(0, 3300) },
    { PPH_RUPIAH_STATIC(2147483647), PPH_MONEY_STATIC(0, 3400) }
};

static const ter_entry_t TER_BULANAN_C[TER_BULANAN_C_COUNT] = {
    { PPH_RUPIAH_STATIC(6600000), PPH_MONEY_STATIC(0, 0) },
    { PPH_RUPIAH_STATIC(6950000), PPH_MONEY_STATIC(0, 25) },
    { PPH_RUPIAH_STATIC(7350000), PPH_MONEY_STATIC(0, 50) },
    { PPH_RUPIAH_STATIC(7800000), PPH_MONEY_STATIC(0, 75) },
    { PPH_RUPIAH_STATIC(8850000), PPH_MONEY_STATIC(0, 100) },
    { PPH_RUPIAH_STATIC(9800000), PPH_MONEY_STATIC(0, 125) },
    { PPH_RUPIAH_STATIC(10950000), PPH_MONEY_STATIC(0, 150) },
    { PPH_RUPIAH_STATIC(11200000), PPH_MONEY_STATIC(0, 175) },
    { PPH_RUPIAH_STATIC(12050000), PPH_MONEY_STATIC(0, 200) },
    { PPH_RUPIAH_STATIC(12950000), PPH_MONEY_STATIC(0, 300) },
    { PPH_RUPIAH_STATIC(14150000), PPH_MONEY_STATIC(0, 400) },
    { PPH_RUPIAH_STATIC(15550000), PPH_MONEY_STATIC(0, 500) },
    { PPH_RUPIAH_STATIC(17050000), PPH_MONEY_STATIC(0, 600) },
    { PPH_RUPIAH_STATIC(19500000), PPH_MONEY_STATIC(0, 700) },
    { PPH_RUPIAH_STATIC(22700000), PPH_MONEY_STATIC(0, 800) },
    { PPH_RUPIAH_STATIC(26600000), PPH_MONEY_STATIC(0, 900) },
    { PPH_RUPIAH_STATIC(28100000), PPH_MONEY_STATIC(0, 1000) },
    { PPH_RUPIAH_STATIC(30100000), PPH_MONEY_STATIC(0, 1100) },
    { PPH_RUPIAH_STATIC(32600000), PPH_MONEY_STATIC(0, 1200) },
    { PPH_RUPIAH_STATIC(35400000), PPH_MONEY_STATIC(0, 1300) },
    { PPH_RUPIAH_STATIC(38900000), PPH_MONEY_STATIC(0, 1400) },
    { PPH_RUPIAH_STATIC(43000000), PPH_MONEY_STATIC(0, 1500) },
    { PPH_RUPIAH_STATIC(47400000), PPH_MONEY_STATIC(0, 1600) },
    { PPH_RUPIAH_STATIC(51200000), PPH_MONEY_STATIC(0, 1700) },
    { PPH_RUPIAH_STATIC(55800000), PPH_MONEY_STATIC(0, 1800) },
    { PPH_RUPIAH_STATIC(60400000), PPH_MONEY_STATIC(0, 1900) },
    { PPH_RUPIAH_STATIC(66700000), PPH_MONEY_STATIC(0, 2000) },
    { PPH_RUPIAH_STATIC(74500000), PPH_MONEY_STATIC(0, 2100) },
    { PPH_RUPIAH_STATIC(83200000), PPH_MONEY_STATIC(0, 2200) },
    { PPH_RUPIAH_STATIC(95600000), PPH_MONEY_STATIC(0, 2300) },
    { PPH_RUPIAH_STATIC(110000000), PPH_MONEY_STATIC(0, 2400) },
    { PPH_RUPIAH_STATIC(134000000), PPH_MONEY_STATIC(0, 2500) },
    { PPH_RUPIAH_STATIC(169000000), PPH_MONEY_STATIC(0, 2600) },
    { PPH_RUPIAH_STATIC(221000000), PPH_MONEY_STATIC(0, 2700) },
    { PPH_RUPIAH_STATIC(390000000), PPH_MONEY_STATIC(0, 2800) },
    { PPH_RUPIAH_STATIC(463000000), PPH_MONEY_STATIC(0, 2900) },
    { PPH_RUPIAH_STATIC(561000000), PPH_MONEY_STATIC(0, 3000) },
    { PPH_RUPIAH_STATIC(709000000), PPH_MONEY_STATIC(0, 3100) },
    { PPH_RUPIAH_STATIC(965000000), PPH_MONEY_STATIC(0, 3200) },
    { PPH_RUPIAH_STATIC(1419000000), PPH_MONEY_STATIC(0, 3300) },
    { PPH_RUPIAH_STATIC(2147483647), PPH_MONEY_STATIC(0, 3400) }
};

pph_money_t pph_get_ter_bulanan_rate(pph21_ter_category_t category, pph_money_t bruto_monthly) {
    const ter_entry_t *table;
    int count, i;
    pph_money_t fallback_rate;

    switch (category) {
        case PPH21_TER_CATEGORY_B:
            table = TER_BULANAN_B;
            count = TER_BULANAN_B_COUNT;
            break;
        case PPH21_TER_CATEGORY_C:
            table = TER_BULANAN_C;
            count = TER_BULANAN_C_COUNT;
            break;
        case PPH21_TER_CATEGORY_A:
        default:
            table = TER_BULANAN_A;
            count = TER_BULANAN_A_COUNT;
            break;
    }

    fallback_rate = table[count - 1].rate;

    for (i = 0; i < count; i++) {
        if (pph_money_cmp(bruto_monthly, table[i].ceiling) <= 0) {
            return table[i].rate;
        }
    }

    return fallback_rate;
}

/* ============================================
   TER Harian (Daily) Tables
   ============================================ */

#define TER_HARIAN_COUNT 3

static const ter_entry_t TER_HARIAN_A[TER_HARIAN_COUNT] = {
    { PPH_RUPIAH_STATIC(750000), PPH_MONEY_STATIC(0, 25) },
    { PPH_RUPIAH_STATIC(2500000), PPH_MONEY_STATIC(0, 150) },
    { PPH_RUPIAH_STATIC(2147483647), PPH_MONEY_STATIC(0, 200) }
};

static const ter_entry_t TER_HARIAN_B[TER_HARIAN_COUNT] = {
    { PPH_RUPIAH_STATIC(750000), PPH_MONEY_STATIC(0, 25) },
    { PPH_RUPIAH_STATIC(2500000), PPH_MONEY_STATIC(0, 125) },
    { PPH_RUPIAH_STATIC(2147483647), PPH_MONEY_STATIC(0, 175) }
};

static const ter_entry_t TER_HARIAN_C[TER_HARIAN_COUNT] = {
    { PPH_RUPIAH_STATIC(750000), PPH_MONEY_STATIC(0, 25) },
    { PPH_RUPIAH_STATIC(2500000), PPH_MONEY_STATIC(0, 100) },
    { PPH_RUPIAH_STATIC(2147483647), PPH_MONEY_STATIC(0, 150) }
};

pph_money_t pph_get_ter_harian_rate(pph21_ter_category_t category, pph_money_t bruto) {
    const ter_entry_t *table;
    int i;

    switch (category) {
        case PPH21_TER_CATEGORY_B:
            table = TER_HARIAN_B;
            break;
        case PPH21_TER_CATEGORY_C:
            table = TER_HARIAN_C;
            break;
        case PPH21_TER_CATEGORY_A:
        default:
            table = TER_HARIAN_A;
            break;
    }

    for (i = 0; i < TER_HARIAN_COUNT; i++) {
        if (pph_money_cmp(bruto, table[i].ceiling) <= 0) {
            return table[i].rate;
        }
    }

    return table[TER_HARIAN_COUNT - 1].rate;
}
